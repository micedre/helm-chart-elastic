---
# ConfigMap for Elasticsearch configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "elasticsearch.fullname" . }}-config
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "elasticsearch.labels" . | nindent 4 }}
    app.kubernetes.io/component: elasticsearch
data:
  elasticsearch.yml: |
    # Default Elasticsearch configuration
    cluster.name: ${cluster.name}
    node.name: ${node.name}
    network.host: ${network.host}

    # Discovery configuration
    {{- if .Values.elasticsearch.clusterMode }}
    discovery.seed_hosts: ${discovery.seed_hosts}
    cluster.initial_master_nodes: ${cluster.initial_master_nodes}
    {{- else }}
    discovery.type: ${discovery.type}
    {{- end }}

    # Path configuration
    path.data: /usr/share/elasticsearch/data
    path.logs: /usr/share/elasticsearch/logs

    # Security configuration
    {{- if .Values.elasticsearch.security.enabled }}
    xpack.security.enabled: ${xpack.security.enabled}
    {{- if .Values.elasticsearch.security.tls.enabled }}
    xpack.security.transport.ssl.enabled: ${xpack.security.transport.ssl.enabled}
    xpack.security.transport.ssl.verification_mode: ${xpack.security.transport.ssl.verification_mode}
    xpack.security.transport.ssl.key: ${xpack.security.transport.ssl.key}
    xpack.security.transport.ssl.certificate: ${xpack.security.transport.ssl.certificate}
    xpack.security.transport.ssl.certificate_authorities: ${xpack.security.transport.ssl.certificate_authorities}
    xpack.security.http.ssl.enabled: ${xpack.security.http.ssl.enabled}
    xpack.security.http.ssl.key: ${xpack.security.http.ssl.key}
    xpack.security.http.ssl.certificate: ${xpack.security.http.ssl.certificate}
    xpack.security.http.ssl.certificate_authorities: ${xpack.security.http.ssl.certificate_authorities}
    {{- end }}
    {{- else }}
    xpack.security.enabled: ${xpack.security.enabled}
    {{- end }}

    # Additional custom configuration
    {{- with .Values.elasticsearch.config }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
{{- if and .Values.elasticsearch.security.enabled .Values.elasticsearch.security.tls.enabled .Values.elasticsearch.security.tls.useSelfSignedCerts }}
{{- if not .Values.elasticsearch.security.tls.certificatesSecret }}
---
# ConfigMap for certificate generation (pre-install hook)
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "elasticsearch.fullname" . }}-cert-config
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "elasticsearch.labels" . | nindent 4 }}
    app.kubernetes.io/component: elasticsearch
  annotations:
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "-10"
    "helm.sh/hook-delete-policy": before-hook-creation
data:
  instances.yml: |
    instances:
    {{- range $i := until (int .Values.elasticsearch.replicas) }}
      - name: {{ include "elasticsearch.fullname" $ }}-{{ $i }}
        dns:
          - {{ include "elasticsearch.fullname" $ }}-{{ $i }}.{{ include "elasticsearch.masterService" $ }}.{{ $.Release.Namespace }}.svc.cluster.local
          - {{ include "elasticsearch.fullname" $ }}-{{ $i }}
          - localhost
        ip:
          - 127.0.0.1
    {{- end }}
{{- end }}
{{- end }}
